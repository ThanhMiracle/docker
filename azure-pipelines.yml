trigger:
  branches:
    include:
      - main
      - dev

# Self-hosted agent pool c·ªßa b·∫°n
pool:
  name: 'Default'

variables:
  # ==== THAY GI√Å TR·ªä N√ÄY THEO M√îI TR∆Ø·ªúNG C·ª¶A B·∫†N ====
  DOCKERHUB_REPO: 'thanhmiracle'          # Docker Hub username
  DOCKERHUB_SERVICE_CONNECTION: 'dockerhub-conn'   # t√™n Docker Registry service connection tr·ªè t·ªõi Docker Hub

  AZURE_SERVICE_CONNECTION: 'azure-spn'   # t√™n Azure Resource Manager service connection
  RESOURCE_GROUP: 'my-rg'                 # resource group ch·ª©a Container Apps

  BACKEND_APP_NAME: 'docker-backend'      # Container App backend
  FRONTEND_APP_NAME: 'docker-frontend'    # Container App frontend
  NGINX_APP_NAME: 'docker-nginx'          # Container App nginx / reverse proxy
  MINIO_APP_NAME: 'docker-minio'          # Container App MinIO

#########################################
# 1) TEST STAGE ‚Äî pytest trong container
#########################################
stages:
- stage: Test
  #condition: eq(variables['Build.SourceBranch'], 'refs/heads/dev')
  displayName: 'Run backend tests'
  jobs:
    - job: TestBackend
      displayName: 'Backend pytest inside container'
      steps:
        - checkout: self

        - script: |
            echo "üîß Starting containers with docker compose..."
            docker compose up -d --build

            echo "üß™ Running pytest inside api container..."
            docker compose exec api pytest -q
          displayName: "Run pytest in backend container"

        - script: |
            echo "üßπ Stopping containers..."
            docker compose down
          displayName: "Cleanup containers"


#########################################
# 2) BUILD STAGE ‚Äî build frontend + 4 images
#########################################
- stage: Build
  dependsOn: Test
  displayName: "Build & Push Docker images"
  condition: succeeded()   # ch·ªâ ch·∫°y n·∫øu Test stage pass

  jobs:
    - job: BuildJob
      displayName: "Build frontend + docker images"
      steps:
        - checkout: self

        #########################################
        # (A) BUILD FRONTEND SOURCE (npm build)
        #########################################
        - task: NodeTool@0
          displayName: "Install Node.js 18"
          inputs:
            versionSpec: '18.x'

        - script: |
            cd frontend
            npm install
            npm run build
          displayName: "Build frontend"

        #########################################
        # (B) Build & Push BACKEND image
        #########################################
        - task: Docker@2
          displayName: 'Build & Push backend'
          inputs:
            command: buildAndPush
            containerRegistry: $(DOCKERHUB_SERVICE_CONNECTION)
            repository: $(DOCKERHUB_REPO)/backend
            dockerfile: backend/Dockerfile
            buildContext: backend
            tags: |
              $(Build.SourceVersion)
              latest

        #########################################
        # (C) Build & Push FRONTEND image
        #########################################
        - task: Docker@2
          displayName: 'Build & Push frontend'
          inputs:
            command: buildAndPush
            containerRegistry: $(DOCKERHUB_SERVICE_CONNECTION)
            repository: $(DOCKERHUB_REPO)/frontend
            dockerfile: frontend/Dockerfile
            buildContext: frontend
            tags: |
              $(Build.SourceVersion)
              latest

        #########################################
        # (D) Build & Push NGINX image
        #########################################
        - task: Docker@2
          displayName: 'Build & Push nginx'
          inputs:
            command: buildAndPush
            containerRegistry: $(DOCKERHUB_SERVICE_CONNECTION)
            repository: $(DOCKERHUB_REPO)/nginx
            dockerfile: nginx/Dockerfile
            buildContext: nginx
            tags: |
              $(Build.SourceVersion)
              latest

      
#########################################
# 3) DEPLOY STAGE ‚Äî ch·ªâ ch·∫°y khi branch = main
#########################################
- stage: Deploy
  dependsOn: Build
  displayName: "Deploy to Azure Container Apps"
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

  jobs:
    - job: DeployJob
      displayName: "Deploy minio + backend + frontend + nginx"
      steps:
        #########################################
        # 1) MinIO ‚Äì deploy TR∆Ø·ªöC
        #########################################
        - task: AzureCLI@2
          displayName: "Deploy minio"
          inputs:
            azureSubscription: $(AZURE_SERVICE_CONNECTION)
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az containerapp update \
                --name $(MINIO_APP_NAME) \
                --resource-group $(RESOURCE_GROUP) \
                --image docker.io/$(DOCKERHUB_REPO)/minio:$(Build.SourceVersion)

        #########################################
        # 2) Backend ‚Äì deploy SAU minio
        #########################################
        - task: AzureCLI@2
          displayName: "Deploy backend"
          inputs:
            azureSubscription: $(AZURE_SERVICE_CONNECTION)
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az containerapp update \
                --name $(BACKEND_APP_NAME) \
                --resource-group $(RESOURCE_GROUP) \
                --image docker.io/$(DOCKERHUB_REPO)/backend:$(Build.SourceVersion)

        #########################################
        # 3) Frontend
        #########################################
        - task: AzureCLI@2
          displayName: "Deploy frontend"
          inputs:
            azureSubscription: $(AZURE_SERVICE_CONNECTION)
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az containerapp update \
                --name $(FRONTEND_APP_NAME) \
                --resource-group $(RESOURCE_GROUP) \
                --image docker.io/$(DOCKERHUB_REPO)/frontend:$(Build.SourceVersion)

        #########################################
        # 4) Nginx
        #########################################
        - task: AzureCLI@2
          displayName: "Deploy nginx"
          inputs:
            azureSubscription: $(AZURE_SERVICE_CONNECTION)
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az containerapp update \
                --name $(NGINX_APP_NAME) \
                --resource-group $(RESOURCE_GROUP) \
                --image docker.io/$(DOCKERHUB_REPO)/nginx:$(Build.SourceVersion)
